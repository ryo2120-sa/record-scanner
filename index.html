<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Record Composer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .canvas-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: crosshair;
            touch-action: none;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        /* Loader styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex flex-col items-center justify-center text-white">
        <div class="loader mb-4"></div>
        <p class="text-lg font-semibold">Processing Image...</p>
        <p class="text-sm opacity-75">Please wait, this may take a moment.</p>
    </div>

    <!-- Sidebar / Controls -->
    <div class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-xl overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-blue-600 text-white flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="file-stack"></i> Record Composer
            </h1>
            <p class="text-blue-100 text-sm mt-1">Combine docs & IDs into one PDF</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            
            <!-- Step 1: Photos -->
            <div class="space-y-4">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">1. Take Photos</h2>
                
                <!-- Main Doc Upload -->
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Main Document (Background)</label>
                    <label for="main-doc" class="custom-file-upload w-full justify-center bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 active:bg-blue-50">
                        <i data-lucide="camera" class="w-4 h-4 mr-2"></i> Take Photo
                    </label>
                    <!-- Added capture="environment" for rear camera priority -->
                    <input id="main-doc" type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'background')">
                </div>

                <!-- Overlays -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Patient ID</label>
                        <label for="id-card" class="custom-file-upload w-full justify-center text-xs bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 active:bg-blue-200">
                            <i data-lucide="camera" class="w-3 h-3 mr-1"></i> Snap ID
                        </label>
                        <input id="id-card" type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'overlay', 'ID Card')">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Insurance</label>
                        <label for="ins-card" class="custom-file-upload w-full justify-center text-xs bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 active:bg-green-200">
                            <i data-lucide="camera" class="w-3 h-3 mr-1"></i> Snap Card
                        </label>
                        <input id="ins-card" type="file" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'overlay', 'Insurance')">
                    </div>
                </div>

                <p class="text-xs text-gray-400 italic">
                    Tip: Drag images on the canvas to position them. Scroll/Pinch to resize overlays.
                </p>

                <!-- Layer Controls (Dynamic) -->
                <div id="layer-controls" class="space-y-2 hidden">
                    <h3 class="text-xs font-semibold text-gray-500 mt-4">Active Overlays</h3>
                    <!-- JS will populate this -->
                </div>
            </div>

            <!-- Step 2: Details -->
            <div class="space-y-4 pt-4 border-t border-gray-100">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">2. Recipient</h2>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email To</label>
                    <input type="email" id="email-input" placeholder="doctor@clinic.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Line</label>
                    <input type="text" id="subject-input" value="Patient Record Scan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            
            <!-- Extra padding for mobile scrolling -->
            <div class="h-20 md:hidden"></div>
        </div>

        <!-- Footer Actions -->
        <div class="p-6 bg-gray-50 border-t border-gray-200 space-y-3 flex-shrink-0 z-20">
            <button onclick="downloadPDF()" class="w-full flex items-center justify-center gap-2 bg-gray-900 hover:bg-black text-white py-3 px-4 rounded-lg font-medium transition-colors shadow-lg active:scale-95 transform transition-transform">
                <i data-lucide="download"></i> Download PDF
            </button>
            <button onclick="composeEmail()" class="w-full flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 py-3 px-4 rounded-lg font-medium transition-colors active:scale-95 transform transition-transform">
                <i data-lucide="mail"></i> Open Email Draft
            </button>
            <p class="text-[10px] text-center text-gray-400">
                * Note: Download PDF first, then attach to email manually.
            </p>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="flex-1 bg-gray-200 flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Canvas wrapper to center it -->
        <div class="relative shadow-2xl bg-white max-w-full max-h-full overflow-auto">
            <canvas id="composer-canvas"></canvas>
            
            <!-- Empty State Placeholder -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center">
                <i data-lucide="scan" class="w-16 h-16 mb-4 opacity-20"></i>
                <p class="text-lg font-medium opacity-40">Take Main Photo to Start</p>
                <p class="text-xs opacity-30 mt-2">Use landscape for best results</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // --- App State ---
        const canvas = document.getElementById('composer-canvas');
        const ctx = canvas.getContext('2d');
        const emptyState = document.getElementById('empty-state');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Canvas sizing (Letter size at roughly 72 DPI screen view, we scale up for PDF)
        // 8.5 x 11 ratio
        const BASE_WIDTH = 612;  // Standard Letter Width in points
        const BASE_HEIGHT = 792; // Standard Letter Height in points
        const SCALE_FACTOR = 1.5; // For better screen resolution
        
        canvas.width = BASE_WIDTH * SCALE_FACTOR;
        canvas.height = BASE_HEIGHT * SCALE_FACTOR;
        
        // Responsive CSS sizing
        function resizeCanvasCSS() {
             // Basic aspect ratio maintenance
            const container = canvas.parentElement.parentElement;
            const maxWidth = container.clientWidth - 40;
            const maxHeight = container.clientHeight - 40;
            
            const aspect = BASE_WIDTH / BASE_HEIGHT;
            
            let cssWidth = maxWidth;
            let cssHeight = maxWidth / aspect;
            
            if (cssHeight > maxHeight) {
                cssHeight = maxHeight;
                cssWidth = maxHeight * aspect;
            }
            
            canvas.style.width = `${cssWidth}px`;
            canvas.style.height = `${cssHeight}px`;
        }
        
        window.addEventListener('resize', resizeCanvasCSS);
        resizeCanvasCSS(); // Init

        // State objects
        let background = null; // The main doc
        let overlays = [];     // Array of overlay objects: { img, x, y, width, height, label, id }
        let selectedOverlayIndex = -1;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        // --- Core Functions ---

        function render() {
            // Clear canvas
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Background
            if (background) {
                emptyState.style.display = 'none';
                ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            } else {
                emptyState.style.display = 'flex';
                // Draw a faint border if empty
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
                return; 
            }

            // Draw Overlays
            overlays.forEach((overlay, index) => {
                ctx.save();
                
                // Draw Shadow for "stickers" effect
                ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // Draw Image
                ctx.drawImage(overlay.img, overlay.x, overlay.y, overlay.width, overlay.height);

                // Draw Selection Border if selected
                if (index === selectedOverlayIndex) {
                    ctx.shadowColor = "transparent"; // Remove shadow for border
                    ctx.strokeStyle = "#2563eb"; // Blue border
                    ctx.lineWidth = 4;
                    ctx.strokeRect(overlay.x, overlay.y, overlay.width, overlay.height);
                    
                    // Draw resize handles (visual only for now, wheel handles resize)
                    ctx.fillStyle = "#2563eb";
                    const handleSize = 10; // Bigger for touch
                    ctx.fillRect(overlay.x - handleSize, overlay.y - handleSize, handleSize*2, handleSize*2);
                    ctx.fillRect(overlay.x + overlay.width - handleSize, overlay.y + overlay.height - handleSize, handleSize*2, handleSize*2);
                }
                ctx.restore();
            });
        }

        // --- Event Handlers ---

        function handleImageUpload(event, type, label = '') {
            const file = event.target.files[0];
            if (!file) return;

            // Show Loading
            loadingOverlay.classList.remove('hidden');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Hide Loading
                    loadingOverlay.classList.add('hidden');
                    
                    if (type === 'background') {
                        background = img;
                        render();
                    } else {
                        // Intelligent placement logic
                        const defaultWidth = canvas.width * 0.4;
                        const ratio = img.height / img.width;
                        const defaultHeight = defaultWidth * ratio;

                        let startX = 20;
                        let startY = 20;

                        if (label.includes('ID')) {
                            startX = canvas.width - defaultWidth - 40;
                            startY = canvas.height * 0.3; 
                        } else if (label.includes('Insurance')) {
                            startX = canvas.width - defaultWidth - 40;
                            startY = canvas.height * 0.7;
                        }

                        overlays.push({
                            id: Date.now(),
                            img: img,
                            x: startX,
                            y: startY,
                            width: defaultWidth,
                            height: defaultHeight,
                            label: label
                        });
                        selectedOverlayIndex = overlays.length - 1; 
                        updateLayerControls();
                        render();
                    }
                    // Reset input so same file can be selected again if needed
                    event.target.value = '';
                };
                
                img.onerror = function() {
                    loadingOverlay.classList.add('hidden');
                    alert("Failed to load image. Please try a different photo.");
                };

                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                loadingOverlay.classList.add('hidden');
                alert("Error reading file. Please try again.");
            };

            // Read the file
            reader.readAsDataURL(file);
        }

        function updateLayerControls() {
            const container = document.getElementById('layer-controls');
            container.innerHTML = '<h3 class="text-xs font-semibold text-gray-500 mt-4 mb-2">Overlays (Select to Resize)</h3>';
            
            if (overlays.length > 0) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }

            overlays.forEach((overlay, index) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded text-sm cursor-pointer ${index === selectedOverlayIndex ? 'bg-blue-100 border-blue-200 border' : 'bg-white border border-gray-200'}`;
                div.innerHTML = `
                    <span class="truncate font-medium ${index === selectedOverlayIndex ? 'text-blue-700' : 'text-gray-700'}">${overlay.label}</span>
                    <button class="text-red-400 hover:text-red-600 p-1" onclick="removeOverlay(event, ${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                `;
                div.onclick = () => {
                    selectedOverlayIndex = index;
                    render();
                    updateLayerControls();
                };
                container.appendChild(div);
            });
        }

        window.removeOverlay = function(e, index) {
            e.stopPropagation();
            overlays.splice(index, 1);
            selectedOverlayIndex = -1;
            render();
            updateLayerControls();
        }

        // --- Interaction Logic (Drag & Resize) ---

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            // Handle both touch and mouse
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;

            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function handleStart(e) {
             // Prevent default only if inside canvas to prevent scrolling while dragging
             // But we need to be careful not to block scrolling entirely on page
            
            const pos = getMousePos(e);
            
            let clickedIndex = -1;
            for (let i = overlays.length - 1; i >= 0; i--) {
                const o = overlays[i];
                if (pos.x >= o.x && pos.x <= o.x + o.width &&
                    pos.y >= o.y && pos.y <= o.y + o.height) {
                    clickedIndex = i;
                    break;
                }
            }

            if (clickedIndex !== -1) {
                e.preventDefault(); // Lock scroll when dragging an item
                selectedOverlayIndex = clickedIndex;
                isDragging = true;
                dragStartX = pos.x - overlays[clickedIndex].x;
                dragStartY = pos.y - overlays[clickedIndex].y;
                render();
                updateLayerControls();
            } else {
                // Background click - don't prevent default so user can scroll page
                selectedOverlayIndex = -1;
                render();
                updateLayerControls();
            }
        }

        function handleMove(e) {
            if (isDragging && selectedOverlayIndex !== -1) {
                e.preventDefault(); // Stop scrolling while dragging
                const pos = getMousePos(e);
                const overlay = overlays[selectedOverlayIndex];
                overlay.x = pos.x - dragStartX;
                overlay.y = pos.y - dragStartY;
                render();
            }
        }

        function handleEnd() {
            isDragging = false;
        }

        // Mouse Events
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);

        // Touch Events
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd);

        // Resize with Mouse Wheel
        canvas.addEventListener('wheel', function(e) {
            if (selectedOverlayIndex !== -1) {
                e.preventDefault();
                const overlay = overlays[selectedOverlayIndex];
                const scaleAmount = 0.05;
                const aspect = overlay.height / overlay.width;
                
                let newWidth = overlay.width;
                
                if (e.deltaY < 0) {
                    newWidth = overlay.width * (1 + scaleAmount);
                } else {
                    newWidth = overlay.width * (1 - scaleAmount);
                }

                if (newWidth > 20 && newWidth < canvas.width) {
                    overlay.width = newWidth;
                    overlay.height = newWidth * aspect;
                    render();
                }
            }
        }, { passive: false });

        // --- Output Functions ---

        async function downloadPDF() {
            if (!background) {
                alert("Please take a photo of the main document first.");
                return;
            }

            loadingOverlay.classList.remove('hidden');
            
            // Allow UI to update before blocking thread
            setTimeout(() => {
                try {
                    const tempSelection = selectedOverlayIndex;
                    selectedOverlayIndex = -1;
                    render();

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'p',
                        unit: 'pt',
                        format: 'letter'
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.80);
                    doc.addImage(imgData, 'JPEG', 0, 0, 612, 792);

                    const subject = document.getElementById('subject-input').value || 'scanned_record';
                    const filename = `${subject.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                    
                    doc.save(filename);

                    selectedOverlayIndex = tempSelection;
                    render();
                } catch (err) {
                    alert("Error creating PDF: " + err.message);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }, 100);
        }

        function composeEmail() {
            const email = document.getElementById('email-input').value;
            const subject = document.getElementById('subject-input').value;
            const body = "Please find the attached patient record and insurance information.";
            
            if (!email) {
                alert("Please enter a recipient email address.");
                document.getElementById('email-input').focus();
                return;
            }

            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        render();

    </script>
</body>
</html>
