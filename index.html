<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patient Record Composer 1.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .canvas-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: crosshair;
            touch-action: none;
        }
        
        .hidden-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        .custom-file-upload {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex flex-col items-center justify-center text-white px-4 text-center">
        <div class="loader mb-4"></div>
        <p class="text-lg font-semibold" id="loading-text">Processing Image...</p>
        <p class="text-sm opacity-75 mt-2">Please wait...</p>
    </div>

    <!-- Sidebar / Controls -->
    <div class="w-full md:w-1/3 lg:w-1/4 bg-white border-r border-gray-200 flex flex-col h-full z-10 shadow-xl overflow-hidden relative">
        <div class="p-6 border-b border-gray-100 bg-purple-700 text-white flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="file-stack"></i> Record Composer 1.5
            </h1>
            <p class="text-purple-100 text-sm mt-1">Render Debugging</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-24">
            
            <!-- Step 1: Photos -->
            <div class="space-y-4">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">1. Take Photos</h2>
                
                <!-- Main Doc Upload -->
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Main Document (Background)</label>
                    <label for="input-main-doc" class="custom-file-upload w-full justify-center bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 active:bg-blue-50">
                        <i data-lucide="camera" class="w-4 h-4 mr-2"></i> Take Photo
                    </label>
                    <input id="input-main-doc" class="hidden-input" type="file" accept="image/*" capture="environment">
                </div>

                <!-- Overlays -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Patient ID</label>
                        <label for="input-id-card" class="custom-file-upload w-full justify-center text-xs bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 active:bg-blue-200">
                            <i data-lucide="camera" class="w-3 h-3 mr-1"></i> Snap ID
                        </label>
                        <input id="input-id-card" class="hidden-input" type="file" accept="image/*" capture="environment">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Insurance</label>
                        <label for="input-ins-card" class="custom-file-upload w-full justify-center text-xs bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 active:bg-green-200">
                            <i data-lucide="camera" class="w-3 h-3 mr-1"></i> Snap Card
                        </label>
                        <input id="input-ins-card" class="hidden-input" type="file" accept="image/*" capture="environment">
                    </div>
                </div>

                <!-- Debug Log Area -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-xs font-bold text-gray-400 mb-2">SYSTEM LOG</h3>
                    <div id="debug-log" class="bg-black text-green-400 text-[10px] font-mono p-2 h-32 overflow-y-auto rounded shadow-inner whitespace-pre-wrap">
                        > App 1.5 initialized...
                    </div>
                </div>
            </div>

            <!-- Step 2: Details -->
            <div class="space-y-4 pt-4 border-t border-gray-100">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">2. Recipient</h2>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email To</label>
                    <input type="email" id="email-input" placeholder="doctor@clinic.com" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Line</label>
                    <input type="text" id="subject-input" value="Patient Record Scan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            
            <div class="h-20 md:hidden"></div>
        </div>

        <!-- Footer Actions -->
        <div class="p-6 bg-gray-50 border-t border-gray-200 space-y-3 flex-shrink-0 z-20">
            <button onclick="downloadPDF()" class="w-full flex items-center justify-center gap-2 bg-gray-900 hover:bg-black text-white py-3 px-4 rounded-lg font-medium transition-colors shadow-lg active:scale-95 transform transition-transform">
                <i data-lucide="download"></i> Download PDF
            </button>
            <button onclick="composeEmail()" class="w-full flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 py-3 px-4 rounded-lg font-medium transition-colors active:scale-95 transform transition-transform">
                <i data-lucide="mail"></i> Open Email Draft
            </button>
        </div>
    </div>

    <!-- Main Canvas Area -->
    <div class="flex-1 bg-gray-200 flex items-center justify-center p-4 relative overflow-hidden">
        <div class="relative shadow-2xl bg-white max-w-full max-h-full overflow-auto">
            <canvas id="composer-canvas"></canvas>
            
            <!-- Empty State Placeholder -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 pointer-events-none p-4 text-center bg-white z-10">
                <i data-lucide="scan" class="w-16 h-16 mb-4 opacity-20"></i>
                <p class="text-lg font-medium opacity-40">Take Main Photo to Start</p>
                <p class="text-xs opacity-30 mt-2">Check log if camera fails</p>
            </div>
        </div>
    </div>

    <script>
        // --- LOGGER UTILITY ---
        function log(msg) {
            const el = document.getElementById('debug-log');
            if(el) {
                const time = new Date().toLocaleTimeString().split(' ')[0];
                el.innerHTML += `\n[${time}] ${msg}`;
                el.scrollTop = el.scrollHeight; 
            }
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`ERROR: ${message}`);
            alert(`App Error: ${message}`);
        };

        try {
            lucide.createIcons();
            log("Icons loaded");
        } catch(e) {
            log("Icon load failed: " + e.message);
        }

        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Ready. Binding inputs...");
            
            const bindInput = (id, type, label) => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('click', () => {
                        log(`Input Clicked: ${label}`);
                    });
                    el.addEventListener('change', (e) => {
                        log(`Change Event Fired: ${label}`);
                        handleImageUpload(e, type, label);
                    });
                } else {
                    log(`ERROR: Could not find input ${id}`);
                }
            };

            bindInput('input-main-doc', 'background', 'Main Doc');
            bindInput('input-id-card', 'overlay', 'ID Card');
            bindInput('input-ins-card', 'overlay', 'Insurance');
        });

        // --- App State ---
        const canvas = document.getElementById('composer-canvas');
        const ctx = canvas.getContext('2d');
        const emptyState = document.getElementById('empty-state');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // Slightly reduced scale for safety on old devices
        const BASE_WIDTH = 612;
        const BASE_HEIGHT = 792;
        const SCALE_FACTOR = 1.0; 
        
        canvas.width = BASE_WIDTH * SCALE_FACTOR;
        canvas.height = BASE_HEIGHT * SCALE_FACTOR;
        
        function resizeCanvasCSS() {
            const container = canvas.parentElement.parentElement;
            if(!container) return;
            const maxWidth = container.clientWidth - 40;
            const maxHeight = container.clientHeight - 40;
            const aspect = BASE_WIDTH / BASE_HEIGHT;
            let cssWidth = maxWidth;
            let cssHeight = maxWidth / aspect;
            
            // Safety: Ensure we don't end up with 0
            if (cssWidth < 50) cssWidth = 300;
            if (cssHeight < 50) cssHeight = 400;

            if (cssHeight > maxHeight && maxHeight > 50) {
                cssHeight = maxHeight;
                cssWidth = maxHeight * aspect;
            }
            
            canvas.style.width = `${cssWidth}px`;
            canvas.style.height = `${cssHeight}px`;
            // log(`Canvas CSS Resized: ${cssWidth}x${cssHeight}`);
        }
        
        window.addEventListener('resize', resizeCanvasCSS);
        setTimeout(resizeCanvasCSS, 500); // Late bind resize to ensure layout is done

        let background = null;
        let overlays = [];
        let selectedOverlayIndex = -1;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        // --- Render Loop (FIX 1.5: Detailed Logging & Robustness) ---
        function render() {
            try {
                // log(`Render Triggered. BG exists? ${!!background}`);
                
                // Clear
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (background) {
                    // FIX: Use classList to strictly hide the empty state
                    emptyState.classList.add('hidden'); 
                    
                    // Draw
                    ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
                } else {
                    emptyState.classList.remove('hidden');
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(0, 0, canvas.width, canvas.height);
                    return; 
                }

                // Overlays
                overlays.forEach((overlay, index) => {
                    ctx.save();
                    ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    ctx.drawImage(overlay.img, overlay.x, overlay.y, overlay.width, overlay.height);

                    if (index === selectedOverlayIndex) {
                        ctx.shadowColor = "transparent";
                        ctx.strokeStyle = "#2563eb";
                        ctx.lineWidth = 4;
                        ctx.strokeRect(overlay.x, overlay.y, overlay.width, overlay.height);
                        
                        // Handles
                        ctx.fillStyle = "#2563eb";
                        const handleSize = 15;
                        ctx.fillRect(overlay.x - handleSize, overlay.y - handleSize, handleSize*2, handleSize*2);
                        ctx.fillRect(overlay.x + overlay.width - handleSize, overlay.y + overlay.height - handleSize, handleSize*2, handleSize*2);
                    }
                    ctx.restore();
                });
            } catch (e) {
                log(`RENDER ERROR: ${e.message}`);
                alert(`Render Error: ${e.message}`);
            }
        }

        // --- Image Handling ---

        function handleImageUpload(event, type, label = '') {
            try {
                const files = event.target.files;
                if (files.length === 0) return;
                
                const file = files[0];
                log(`File: ${file.type} (${(file.size/1024/1024).toFixed(2)}MB)`);

                loadingText.innerText = "Processing...";
                loadingOverlay.classList.remove('hidden');

                const objectUrl = URL.createObjectURL(file);
                
                const img = new Image();
                img.onload = function() {
                    log("Img loaded. Resizing...");
                    
                    setTimeout(() => { // Force async break
                        try {
                            const MAX_DIM = 1200; 
                            let w = img.width;
                            let h = img.height;
                            
                            if (w > MAX_DIM || h > MAX_DIM) {
                                const scale = Math.min(MAX_DIM / w, MAX_DIM / h);
                                w = Math.floor(w * scale);
                                h = Math.floor(h * scale);
                            }

                            const tempCvs = document.createElement('canvas');
                            tempCvs.width = w;
                            tempCvs.height = h;
                            const tempCtx = tempCvs.getContext('2d');
                            tempCtx.drawImage(img, 0, 0, w, h);

                            URL.revokeObjectURL(objectUrl);

                            const optimizedImg = new Image();
                            optimizedImg.onload = function() {
                                log("Optimized Img Ready. Calling Render...");
                                processOptimizedImage(optimizedImg, type, label);
                                loadingOverlay.classList.add('hidden');
                                log("Render Complete. Loading Hidden.");
                            };
                            optimizedImg.onerror = function(e) {
                                log("Error loading optimized image.");
                                loadingOverlay.classList.add('hidden');
                            };
                            optimizedImg.src = tempCvs.toDataURL('image/jpeg', 0.80);

                        } catch (err) {
                            log("Resize Error: " + err.message);
                            loadingOverlay.classList.add('hidden');
                        }
                    }, 50);
                };

                img.onerror = function(e) {
                    log("Error loading raw blob.");
                    loadingOverlay.classList.add('hidden');
                };
                img.src = objectUrl;
                event.target.value = '';

            } catch (err) {
                log("Upload Error: " + err.message);
                loadingOverlay.classList.add('hidden');
            }
        }

        function processOptimizedImage(img, type, label) {
            log(`Processing: ${type}`);
            if (type === 'background') {
                background = img;
                // Force resize before first render to ensure canvas isn't 0x0
                resizeCanvasCSS(); 
                render();
            } else {
                const defaultWidth = canvas.width * 0.4;
                const ratio = img.height / img.width;
                const defaultHeight = defaultWidth * ratio;

                let startX = 20;
                let startY = 20;

                if (label.includes('ID')) {
                    startX = canvas.width - defaultWidth - 40;
                    startY = canvas.height * 0.3; 
                } else if (label.includes('Insurance')) {
                    startX = canvas.width - defaultWidth - 40;
                    startY = canvas.height * 0.7;
                }

                overlays.push({
                    id: Date.now(),
                    img: img,
                    x: startX,
                    y: startY,
                    width: defaultWidth,
                    height: defaultHeight,
                    label: label
                });
                selectedOverlayIndex = overlays.length - 1; 
                render();
            }
        }

        window.removeOverlay = function(e, index) {
            e.stopPropagation();
            overlays.splice(index, 1);
            selectedOverlayIndex = -1;
            render();
        }

        // --- Interaction Logic ---
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function handleStart(e) {
            const pos = getMousePos(e);
            let clickedIndex = -1;
            for (let i = overlays.length - 1; i >= 0; i--) {
                const o = overlays[i];
                if (pos.x >= o.x && pos.x <= o.x + o.width &&
                    pos.y >= o.y && pos.y <= o.y + o.height) {
                    clickedIndex = i;
                    break;
                }
            }
            if (clickedIndex !== -1) {
                e.preventDefault(); 
                selectedOverlayIndex = clickedIndex;
                isDragging = true;
                dragStartX = pos.x - overlays[clickedIndex].x;
                dragStartY = pos.y - overlays[clickedIndex].y;
                render();
            } else {
                selectedOverlayIndex = -1;
                render();
            }
        }

        function handleMove(e) {
            if (isDragging && selectedOverlayIndex !== -1) {
                e.preventDefault();
                const pos = getMousePos(e);
                const overlay = overlays[selectedOverlayIndex];
                overlay.x = pos.x - dragStartX;
                overlay.y = pos.y - dragStartY;
                render();
            }
        }

        function handleEnd() {
            isDragging = false;
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseleave', handleEnd);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd);

        canvas.addEventListener('wheel', function(e) {
            if (selectedOverlayIndex !== -1) {
                e.preventDefault();
                const overlay = overlays[selectedOverlayIndex];
                const scaleAmount = 0.05;
                const aspect = overlay.height / overlay.width;
                let newWidth = overlay.width;
                if (e.deltaY < 0) {
                    newWidth = overlay.width * (1 + scaleAmount);
                } else {
                    newWidth = overlay.width * (1 - scaleAmount);
                }
                if (newWidth > 20 && newWidth < canvas.width) {
                    overlay.width = newWidth;
                    overlay.height = newWidth * aspect;
                    render();
                }
            }
        }, { passive: false });

        async function downloadPDF() {
            if (!background) {
                alert("Please take a photo of the main document first.");
                return;
            }
            loadingText.innerText = "Generating PDF...";
            loadingOverlay.classList.remove('hidden');
            setTimeout(() => {
                try {
                    const tempSelection = selectedOverlayIndex;
                    selectedOverlayIndex = -1;
                    render();
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'letter' });
                    const imgData = canvas.toDataURL('image/jpeg', 0.80);
                    doc.addImage(imgData, 'JPEG', 0, 0, 612, 792);
                    const subject = document.getElementById('subject-input').value || 'scanned_record';
                    const filename = `${subject.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                    doc.save(filename);
                    selectedOverlayIndex = tempSelection;
                    render();
                    log("PDF Generated: " + filename);
                } catch (err) {
                    log("PDF Error: " + err.message);
                    alert("Error creating PDF: " + err.message);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            }, 100);
        }

        function composeEmail() {
            const email = document.getElementById('email-input').value;
            const subject = document.getElementById('subject-input').value;
            const body = "Please find the attached patient record and insurance information.";
            if (!email) {
                alert("Please enter a recipient email address.");
                document.getElementById('email-input').focus();
                return;
            }
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        render();
        log("App Ready.");
    </script>
</body>
</html>
